<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dónde he aparcado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json">

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="app">
    <div id="permission-notification">
        <strong>Atención:</strong> Para usar esta aplicación, necesitas activar los permisos de ubicación.
        <br>
        <button id="request-permission-btn">Habilitar Permisos</button>
    </div>

    <!-- Parte superior: mapa -->
    <header class="app__top">
      <div id="map"></div>
    </header>

    <!-- Parte central: botón -->
    <main class="app__middle">
      <button id="saveBtn">Guardar ubicación de aparcamiento</button>
      <button id="recenterBtn">Ver mi ubicación real</button>
      <p class="hint">
        Consejo: pulsa en el mapa para ajustar la ubicación manualmente.
      </p>
      <p id="message" class="message"></p>
      <div id="install-container" style="display: none;">
          <p style="margin: 0 0 5px;">¡Instala la app para un acceso más fácil!</p>
          <button id="install-button">Instalar</button>
      </div>
    </main>

    <!-- Parte inferior: histórico -->
    <section class="app__bottom">
      <h2>Histórico de ubicaciones</h2>
      <ul id="locationsList"></ul>
    </section>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // --- PWA and Permissions Logic ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => console.log('Service Worker registered:', registration))
          .catch(error => console.log('Service Worker registration failed:', error));
      });
    }

    let deferredPrompt;
    const installContainer = document.getElementById('install-container');
    const installButton = document.getElementById('install-button');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installContainer.style.display = 'block';
    });

    installButton.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`User response to the install prompt: ${outcome}`);
        deferredPrompt = null;
        installContainer.style.display = 'none';
      }
    });

    const permissionNotification = document.getElementById('permission-notification');
    const requestPermissionBtn = document.getElementById('request-permission-btn');

    requestPermissionBtn.addEventListener('click', () => {
        tryCenterMapOnCurrentPosition();
    });


    // --- Application Logic ---
    const STORAGE_KEY = "parkingLocations";

    let locations = [];
    let map;
    let currentMarker = null;
    let currentDisplayLocation = null; // Holds { lat, lng } of what's on screen

    const DEFAULT_LOCATION = { lat: 40.4168, lng: -3.7038 };

    // Element getters
    const messageEl = () => document.getElementById("message");
    const locationsListEl = () => document.getElementById("locationsList");
    const saveBtnEl = () => document.getElementById("saveBtn");
    const recenterBtnEl = () => document.getElementById("recenterBtn");

    function showMessage(text, type = "info") {
      const el = messageEl();
      el.textContent = text || "";
      el.className = "message";
      if (type === "error") {
        el.classList.add("message--error");
      } else if (type === "info") {
        el.classList.add("message--info");
      }
    }

    function loadLocationsFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return [];
        return arr;
      } catch (e) {
        console.error("Error leyendo localStorage", e);
        showMessage("No se ha podido leer el histórico de ubicaciones.", "error");
        return [];
      }
    }

    function saveLocationsToStorage() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(locations));
      } catch (e) {
        console.error("Error guardando en localStorage", e);
        showMessage("No se han podido guardar las ubicaciones (¿espacio lleno?).", "error");
      }
    }

    function initMap(initialLat, initialLng) {
      map = L.map("map").setView([initialLat, initialLng], 16);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);
      
      updateMapToLocation({ lat: initialLat, lng: initialLng });

      map.on('click', function(e) {
          const { lat, lng } = e.latlng;
          updateMapToLocation({ lat, lng });
          showMessage('Ubicación ajustada manualmente. Pulsa "Guardar" para confirmar.', 'info');
      });

      setTimeout(() => map.invalidateSize(), 200);
    }

    function updateMapToLocation(location) {
      if (!map) return;
      const { lat, lng } = location;

      map.setView([lat, lng], 17);

      if (!currentMarker) {
        currentMarker = L.marker([lat, lng]).addTo(map);
      } else {
        currentMarker.setLatLng([lat, lng]);
      }
      currentDisplayLocation = { lat, lng };
    }

    function renderLocationList(activeId = null) {
      const list = locationsListEl();
      list.innerHTML = "";

      if (!locations.length) {
        const li = document.createElement("li");
        li.textContent = "No hay ubicaciones guardadas todavía.";
        li.style.fontSize = "13px";
        li.style.color = "#666";
        list.appendChild(li);
        return;
      }

      const sorted = [...locations].sort((a, b) => b.timestamp - a.timestamp);
      const latestId = activeId || sorted[0]?.id;

      sorted.forEach((loc, index) => {
        const li = document.createElement("li");
        li.className = "location-item";
        if (loc.id === latestId) {
          li.classList.add("location-item--active");
        }

        const title = document.createElement("div");
        title.className = "location-item__title";
        title.textContent = `Ubicación #${sorted.length - index}`;

        if (loc.id === sorted[0].id) {
          const tag = document.createElement("span");
          tag.className = "tag";
          tag.textContent = "Actual";
          title.appendChild(tag);
        }

        const date = new Date(loc.timestamp);
        const meta = document.createElement("div");
        meta.className = "location-item__meta";
        meta.textContent = `${date.toLocaleString()} · Lat: ${loc.lat.toFixed(6)}, Lng: ${loc.lng.toFixed(6)}`;

        li.appendChild(title);
        li.appendChild(meta);

        li.addEventListener("click", () => {
          updateMapToLocation(loc);
          // Manage active class directly instead of re-rendering the whole list
          locationsListEl().querySelectorAll('.location-item').forEach(item => item.classList.remove('location-item--active'));
          li.classList.add('location-item--active');
        });

        list.appendChild(li);
      });
    }

    function saveCurrentLocation() {
        if (!currentDisplayLocation) {
            showMessage("No hay ninguna ubicación seleccionada para guardar.", "error");
            return;
        }

        const now = Date.now();
        const newLocation = {
            id: now,
            lat: currentDisplayLocation.lat,
            lng: currentDisplayLocation.lng,
            timestamp: now
        };

        locations.push(newLocation);
        saveLocationsToStorage();
        renderLocationList(newLocation.id);
        showMessage("Ubicación de aparcamiento guardada correctamente.", "info");
    }

    function tryCenterMapOnCurrentPosition() {
      if (!("geolocation" in navigator)) {
        showMessage("La geolocalización no está disponible en este dispositivo.", "error");
        return;
      }
      
      showMessage("Obteniendo tu ubicación GPS...", "info");

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          permissionNotification.style.display = 'none';
          const { latitude, longitude } = pos.coords;
          updateMapToLocation({ lat: latitude, lng: longitude });
          showMessage("Mapa centrado en tu ubicación GPS.", "info");
        },
        (err) => {
          console.warn("No se ha podido centrar en la ubicación actual", err);
          if (err.code === err.PERMISSION_DENIED) {
              permissionNotification.style.display = 'block';
              showMessage("Permiso de ubicación denegado. No se puede mostrar tu posición.", "error");
          } else {
              showMessage("No se ha podido obtener tu ubicación inicial.", "error");
          }
        }
      );
    }

    document.addEventListener("DOMContentLoaded", () => {
      locations = loadLocationsFromStorage();

      let initialLocation = DEFAULT_LOCATION;
      if (locations.length > 0) {
        const sorted = [...locations].sort((a, b) => b.timestamp - a.timestamp);
        initialLocation = sorted[0];
      }

      initMap(initialLocation.lat, initialLocation.lng);

      if (locations.length > 0) {
        showMessage("Mapa centrado en la última ubicación guardada.", "info");
      } else {
        tryCenterMapOnCurrentPosition();
      }

      renderLocationList();

      saveBtnEl().addEventListener("click", saveCurrentLocation);
      recenterBtnEl().addEventListener('click', tryCenterMapOnCurrentPosition);
    });
  </script>
</body>
</html>
